# .github/workflows/scan.yml
# Binance RSI ç›‘æ§è‡ªåŠ¨åŒ–ä»»åŠ¡
# è§¦å‘æ¡ä»¶ï¼šæ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ + æ‰‹åŠ¨è§¦å‘

name: ğŸ” æ‰«æ Binance RSI (15åˆ†é’Ÿçº§åˆ«)

# è§¦å‘æ¡ä»¶
on:
  # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '*/5 * * * *'   # æ¯5åˆ†é’Ÿ
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆä»“åº“ -> Actions æ ‡ç­¾é¡µ -> ç‚¹å‡»å·¥ä½œæµ -> Run workflowï¼‰
  workflow_dispatch:
  # æ¨é€ä»£ç æ—¶ä¹Ÿå¯è§¦å‘ï¼ˆå¯é€‰ï¼‰
  push:
    branches: [ main ]
    paths:
      - 'scan_rsi.py'
      - '.github/workflows/scan.yml'

# ä»»åŠ¡é…ç½®
jobs:
  scan:
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # ä»»åŠ¡æ­¥éª¤
    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆä» GitHub ä»“åº“ä¸‹è½½åˆ°è¿è¡Œç¯å¢ƒï¼‰
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 3. å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆTA-Lib éœ€è¦ build-essentialï¼‰
      - name: ğŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      # 4. å®‰è£… Python ä¾èµ–
      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install pandas numpy requests

      # 5. å®‰è£… TA-Libï¼ˆæŠ€æœ¯æŒ‡æ ‡åº“ï¼‰
      - name: ğŸ“Š å®‰è£… TA-Lib
        run: |
          # ä¸‹è½½é¢„ç¼–è¯‘çš„ wheel åŒ…ï¼ˆé¿å…ä»æºç ç¼–è¯‘ï¼‰
          wget -O ta-lib.tar.gz https://github.com/mrjbq7/ta-lib/releases/download/0.4.24/ta-lib-0.4.24-cp310-cp310-linux_x86_64.whl
          pip install ta-lib.tar.gz
          # éªŒè¯å®‰è£…
          python -c "from talib import RSI; print('âœ… TA-Lib å®‰è£…æˆåŠŸ')"

      # 6. è¿è¡Œä¸»è„šæœ¬
      - name: ğŸš€ è¿è¡Œ RSI æ‰«æè„šæœ¬
        run: |
          python scan_rsi.py

      # 7. æäº¤æ›´æ–°çš„æ–‡ä»¶
      - name: ğŸ“¤ æäº¤æ›´æ–°åˆ° GitHub
        run: |
          git config user.name "RSI Bot"
          git config user.email "rsi@monitor.com"
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´çš„æ–‡ä»¶
          git add data/rsi-history.csv rsi-alerts.csv
          
          # å¦‚æœæœ‰å˜æ›´ï¼Œå°±æäº¤å¹¶æ¨é€
          if git diff --cached --quiet; then
            echo "ğŸŸ¢ æ— æ•°æ®å˜æ›´ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–° RSI æ•°æ® $(date '+%Y-%m-%d %H:%M')"
            git push origin main
            echo "âœ… æ•°æ®å·²æäº¤å¹¶æ¨é€"
          fi
